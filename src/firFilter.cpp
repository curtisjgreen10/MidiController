/*
 * firFilter.cpp
 *
 *  Created on: Apr 13, 2021
 *      Author: cjgree13
 */

#include "firFilter.h"

static float FIR_IMPULSE_RESPONSE[FIR_FILTER_LENGTH] =
{
		-0.000757394718866235953404209002570723896,
		-0.000792605094653389880866856120888996884,
		-0.000871510394860367529693001564794485603,
		-0.000995623649052248312768531590677412169,
		-0.001165882657009137011658306271044693858,
		-0.001382623958774841996244298059082211694,
		-0.001645565026193649554864251172148215119,
		-0.001953795050866680149681542388861998916,
		-0.002305774577119035738392849310685051023,
		-0.002699344097257982705989620697550890327,
		-0.003131741592152744325244784207029624667,
		-0.003599628865063333148233137848137630499,
		-0.004099126382809256327610647474557481473,
		-0.004625856207894413728298754762136013596,
		-0.005174992480172158765272527602974150795,
		-0.005741318789015007438558679808693341329,
		-0.006319291668646561180300302851264859783,
		-0.00690310935202277219796540563834241766 ,
		-0.007486784834009429026591142530833167257,
		-0.008064222223957339882871586667079100152,
		-0.008629295312311427088025617138100642478,
		-0.0091759272365134134097353069137170678  ,
		-0.009698170108873943595639843806566204876,
		-0.010190283463691872725687126433058438124,
		-0.010646810392858757285394766256558796158,
		-0.011062650268344340065418407448305515572,
		-0.011433126995957779842294499417221231852,
		-0.01175405180691023974970388366045881412 ,
		-0.012021779671086276625180389032720995601,
		-0.012233258507365162362501287418581341626,
		-0.012386070470466891899063988091711507877,
		-0.01247846470900690861449700008733998402 ,
		 0.988241108006007284991767392057226970792,
		-0.01247846470900690861449700008733998402 ,
		-0.012386070470466891899063988091711507877,
		-0.012233258507365162362501287418581341626,
		-0.012021779671086276625180389032720995601,
		-0.01175405180691023974970388366045881412 ,
		-0.011433126995957779842294499417221231852,
		-0.011062650268344340065418407448305515572,
		-0.010646810392858757285394766256558796158,
		-0.010190283463691872725687126433058438124,
		-0.009698170108873943595639843806566204876,
		-0.0091759272365134134097353069137170678  ,
		-0.008629295312311427088025617138100642478,
		-0.008064222223957339882871586667079100152,
		-0.007486784834009429026591142530833167257,
		-0.00690310935202277219796540563834241766 ,
		-0.006319291668646561180300302851264859783,
		-0.005741318789015007438558679808693341329,
		-0.005174992480172158765272527602974150795,
		-0.004625856207894413728298754762136013596,
		-0.004099126382809256327610647474557481473,
		-0.003599628865063333148233137848137630499,
		-0.003131741592152744325244784207029624667,
		-0.002699344097257982705989620697550890327,
		-0.002305774577119035738392849310685051023,
		-0.001953795050866680149681542388861998916,
		-0.001645565026193649554864251172148215119,
		-0.001382623958774841996244298059082211694,
		-0.001165882657009137011658306271044693858,
		-0.000995623649052248312768531590677412169,
		-0.000871510394860367529693001564794485603,
		-0.000792605094653389880866856120888996884,
		-0.000757394718866235953404209002570723896,
};


void FirFilter::FirFilterInit(FirData *fir)
{
	for (uint16_t n = 0; n < FIR_FILTER_LENGTH; n++)
	{
		fir->buf[n] = 0.0f;
	}

	fir->bufIndex = 0;
	fir->out = 0.0f;
}

double FirFilter::FirFilterUpdate(FirData *fir, double input)
{
	fir->buf[fir->bufIndex] = input;

	fir->bufIndex++;

	if (fir->bufIndex == FIR_FILTER_LENGTH)
	{
		fir->bufIndex = 0;
	}

	fir->out = 0.0f;

	uint16_t sumIndex = fir->bufIndex;

	for (uint16_t n = 0; n < FIR_FILTER_LENGTH; n++)
	{
		if (sumIndex > 0)
		{
			sumIndex--;
		}
		else
		{
			sumIndex = FIR_FILTER_LENGTH - 1;
		}

		fir->out += FIR_IMPULSE_RESPONSE[n]*fir->buf[sumIndex];

	}

	return fir->out;
}

